{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% block app_content %}
<script language="JavaScript" type="text/javascript" src="{{ url_for('static', filename='jquery-3.3.1.js') }}"></script>
<div class="popup" style="visibility:hidden" >
        <span class="popuptext" id="myPopup">Display end
            <button class="btn ml-4" onclick="download_log()">download</button>
        </span>
    </div>
<div class="container" id="game_playground">
    <h2> game_playground </h2>
    
    <div id="game_display">
        <div class="row" style="height:500px">
    
                <div class =playground>
                <div class="ball"></div>
                <div class = "left-goalkeeper goalkeeper"></div>
                <div class = "right-goalkeeper goalkeeper"></div>
                </div>
        </div>
    </div>
</div>

<link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
<link rel=stylesheet type=text/css href="{{ url_for('static', filename='gameover.css') }}">

<script>
    let display_content ={{content}}
    var startTime=new Date();
    var speed=10;
    var start_flag=0;

    function ball_update(position){
        var width = $(".ball").outerWidth();
        var height = $(".ball").outerHeight();
        // console.log($(".ball").left())
        $(".ball").css({"left":position[0]-width/2,"top":position[1]-height/2});
    }
    function paddle_update(position,direction){
        var windowHeight = $(window).height();
        var height =direction.outerHeight();
        var p_top = position[1]-height/2;
        var topMax = windowHeight - p_top - 5;
        if (p_top < 5) p_top = 5;
        if (p_top > topMax) p_top = topMax;
        direction.css("top",p_top);	
    }
    function score_update(newscores){
        Scores.setLeft(newscores[0]);
        Scores.setRight(newscores[1]);
    }
    function display_end(){
        var popup = document.getElementById("myPopup");
        popup.classList.toggle("show");
    }
    function download_log(){
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(display_content));
        element.setAttribute('download', 'log_'+{{log_id}});
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
    
    
    if( {{func_type}} ){ //func_type==1 -> display
        var refreshIntervalId=setInterval(function(){
            position=display_content.shift();
            if(position == undefined){
                console.log("clearInterval");
                clearInterval(refreshIntervalId);
                display_end();
            }else{ 
            let left = $('.left-goalkeeper')
            let right = $('.right-goalkeeper')
            ball_update(position[0]);
            paddle_update(position[1],left);
            paddle_update(position[2],right);
            }
        },speed);
    }else{
        download_log();
    }


    </script>
    {% endblock %}